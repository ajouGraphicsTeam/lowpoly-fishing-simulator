<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <title>JH</title>

    <script id="vertex-shader" type="x-shader/x-vertex">
      attribute vec4 aVertexPosition;
      attribute vec3 aVertexNormal;
      varying vec4 fColor;

      uniform mat4 uModelMat;
      uniform mat4 uViewMat;
      uniform mat4 uProjectionMat;

      uniform vec4 ambientProduct, diffuseProduct, specularProduct;
      uniform vec4 lightPosition;
      uniform float shininess;

      void main() {
        vec3 pos = (uViewMat * uModelMat * aVertexPosition).xyz;

        //fixed light position
        vec3 light = lightPosition.xyz;
        vec3 L = normalize( light - pos );
        vec3 E = normalize( -pos );
        vec3 H = normalize( L + E ); // halfway vector for Blinn-Phong shading
        vec4 NN = vec4(aVertexNormal, 0);

        // Transform vertex normal into eye coordinates
        vec3 N = normalize( (uViewMat * uModelMat * NN).xyz );

        // Compute terms in the illumination equation
        vec4 ambient = ambientProduct;
        float d_val = max( dot(L, N), 0.0 );
        vec4 diffuse = d_val * diffuseProduct;
        float s_val = pow( max(dot(N, H), 0.0), shininess );
        vec4 specular = s_val * specularProduct;

        // in case the light source is behind the surface
        if( dot(L, N) < 0.0 ) {
          specular = vec4(0.0, 0.0, 0.0, 1.0);
        }

        fColor = ambient + diffuse + specular;
        fColor.a = 1.0;


        gl_PointSize = 5.0;
        gl_Position = uProjectionMat * uViewMat * uModelMat * aVertexPosition;
      }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
      varying lowp vec4 fColor;

      void main() {
          gl_FragColor = fColor;
      }
    </script>

    <script type="text/javascript" src="Common/webgl-utils.js"></script>
    <script type="text/javascript" src="Common/initShaders.js"></script>
    <script type="text/javascript" src="Common/MV.js"></script>

    <script type="text/javascript" src="src/models/transform.js"></script>
    <script type="text/javascript" src="src/models/camera.js"></script>
    <script type="text/javascript" src="src/prototypes.js"></script>
    <script type="text/javascript" src="src/animation.js"></script>
    <script type="text/javascript" src="src/modelViewMat.js"></script>
    <script type="text/javascript" src="src/lighting.js"></script>
    <script type="text/javascript" src="src/primitives.js"></script>

    <script type="text/javascript" src="src/managers/rootManager.js"></script>
    <script
      type="text/javascript"
      src="src/managers/primitiveManager.js"></script>
    <script
      type="text/javascript"
      src="src/managers/animationManager.js"></script>
    <script
      type="text/javascript"
      src="src/managers/hierarchyManager.js"></script>
    <script type="text/javascript" src="src/managers/canvasManager.js"></script>
    <script type="text/javascript" src="src/managers/cameraManager.js"></script>

    <script type="text/javascript" src="fishing.js"></script>
  </head>

  <body>
    <div id="body" class="flex gap-2">
      <canvas id="gl-canvas" width="1024" height="1024">
        Oops ... your browser doesn't support the HTML5 canvas element
      </canvas>

      <div>
        <div id="panel" class="flex flex-col gap-2">
          <div class="camera">
            <p>camera:</p>

            <div class="flex gap-4">
              <label class="ml-4">- preset</label>
              <div>
                <button id="frontCamera" type="button" class="border px-1">
                  front
                </button>
                <button id="sideCamera" type="button" class="border px-1">
                  side
                </button>
                <button id="topCamera" type="button" class="border px-1">
                  top
                </button>
              </div>
            </div>

            <label class="ml-4">- eye</label>
            <div class="ml-7">
              <div class="my-1">
                <label>X: </label>
                <input
                  id="eye_x"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Y: </label>
                <input
                  id="eye_y"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Z: </label>
                <input
                  id="eye_z"
                  type="number"
                  value="1"
                  step="0.01"
                  class="border pl-1" />
              </div>
            </div>

            <label class="ml-4">- at</label>
            <div class="ml-7">
              <div class="my-1">
                <label>X: </label>
                <input
                  id="at_x"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Y: </label>
                <input
                  id="at_y"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Z: </label>
                <input
                  id="at_z"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
            </div>

            <label class="ml-4">- up</label>
            <div class="ml-7">
              <div class="my-1">
                <label>X: </label>
                <input
                  id="up_x"
                  type="number"
                  value="0"
                  step="1"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Y: </label>
                <input
                  id="up_y"
                  type="number"
                  value="1"
                  step="1"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Z: </label>
                <input
                  id="up_z"
                  type="number"
                  value="0"
                  step="1"
                  class="border pl-1" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script id="main">
      const rootManager = new RootManager();
      rootManager.init();

      // // for test
      const box = new BoxPrimitive([
        [0, 0.4, 0.025],
        [0.1, 0.4, 0.025],
        [0.1, -0.4, 0.025],
        [0, -0.4, 0.025],
        [0, 0.4, -0.025],
        [0.1, 0.4, -0.025],
        [0.1, -0.4, -0.025],
        [0, -0.4, -0.025],
      ]);
      const box2 = new BoxPrimitive([
        [0.1, 0.4, 0.025],
        [0.2, 0.4, 0.025],
        [0.2, -0.4, 0.025],
        [0.1, -0.4, 0.025],
        [0.1, 0.4, -0.025],
        [0.2, 0.4, -0.025],
        [0.2, -0.4, -0.025],
        [0.1, -0.4, -0.025],
      ]);
      const hierarchyManager = new HierarchyManager();
      const child = new HierarchyManager();
      const child2 = new HierarchyManager();

      hierarchyManager.children.push(child);
      child.children.push(child2);

      hierarchyManager.primitives = [box];
      child.primitives = [box, box2];
      child2.primitives = [box];

      hierarchyManager.transform.position = vec3(0.1, 0.1, 0);
      child.transform.rotation = vec3(0, 0, -30);
      child2.transform.anchor = vec3(0, 0.4, 0);
      child2.transform.rotation = vec3(0, 0, 120);

      hierarchyManager.drawRecursively();

      resetCamera = () => {
        eye_x.value = 0;
        eye_y.value = 0;
        eye_z.value = 1;
        at_x.value = 0;
        at_y.value = 0;
        at_z.value = 0;
        up_x.value = 0;
        up_y.value = 1;
        up_z.value = 0;
      };

      frontCamera.addEventListener("click", (event) => {
        resetCamera();
      });
      sideCamera.addEventListener("click", (event) => {
        resetCamera();

        eye_x.value = 1;
        eye_y.value = 0;
        eye_z.value = 0;
      });
      topCamera.addEventListener("click", (event) => {
        resetCamera();

        eye_x.value = 0;
        eye_y.value = 1;
        eye_z.value = 0;

        up_x.value = 0;
        up_y.value = 0;
        up_z.value = -1;
      });
    </script>
  </body>
</html>
