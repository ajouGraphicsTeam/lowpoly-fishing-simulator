<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <title>JH</title>

    <script id="vertex-shader" type="x-shader/x-vertex">
      attribute vec4 aVertexPosition;
      attribute vec3 aVertexNormal;
      varying vec4 fColor;

      uniform mat4 uModelMat;
      uniform mat4 uViewMat;
      uniform mat4 uProjectionMat;

      uniform vec4 ambientProduct, diffuseProduct, specularProduct;
      uniform vec4 lightPosition;
      uniform float shininess;

      void main() {
        vec3 pos = (uViewMat * uModelMat * aVertexPosition).xyz;

        //fixed light position
        vec3 light = lightPosition.xyz;
        vec3 L = normalize( light - pos );
        vec3 E = normalize( -pos );
        vec3 H = normalize( L + E ); // halfway vector for Blinn-Phong shading
        vec4 NN = vec4(aVertexNormal, 0);

        // Transform vertex normal into eye coordinates
        vec3 N = normalize( (uViewMat * uModelMat * NN).xyz );

        // Compute terms in the illumination equation
        vec4 ambient = ambientProduct;
        float d_val = max( dot(L, N), 0.0 );
        vec4 diffuse = d_val * diffuseProduct;
        float s_val = pow( max(dot(N, H), 0.0), shininess );
        vec4 specular = s_val * specularProduct;

        // in case the light source is behind the surface
        if( dot(L, N) < 0.0 ) {
          specular = vec4(0.0, 0.0, 0.0, 1.0);
        }

        fColor = ambient + diffuse + specular;
        fColor.a = 1.0;


        gl_PointSize = 5.0;
        gl_Position = uProjectionMat * uViewMat * uModelMat * aVertexPosition;
      }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
      varying lowp vec4 fColor;

      void main() {
          gl_FragColor = fColor;
      }
    </script>

    <script type="text/javascript" src="Common/webgl-utils.js"></script>
    <script type="text/javascript" src="Common/initShaders.js"></script>
    <script type="text/javascript" src="Common/MV.js"></script>

    <script type="text/javascript" src="src/constants.js"></script>
    <script type="text/javascript" src="src/prototypes.js"></script>
    <script type="text/javascript" src="src/components/animation.js"></script>
    <script type="text/javascript" src="src/components/transform.js"></script>
    <script type="text/javascript" src="src/components/primitives.js"></script>
    <script
      type="text/javascript"
      src="src/objects/hierarchyObject.js"></script>
    <script type="text/javascript" src="src/objects/prefabObject.js"></script>
    <script type="text/javascript" src="src/managers/rootManager.js"></script>
    <script
      type="text/javascript"
      src="src/managers/animationManager.js"></script>
    <script type="text/javascript" src="src/managers/canvasManager.js"></script>
    <script type="text/javascript" src="src/managers/cameraManager.js"></script>

    <script type="text/javascript" src="fishing.js"></script>

    <script type="text/javascript" src="src/data/prefabs/robotArm.js"></script>
  </head>

  <body>
    <div id="body" class="flex gap-2">
      <canvas id="gl-canvas" width="1024" height="1024">
        Oops ... your browser doesn't support the HTML5 canvas element
      </canvas>

      <div>
        <div id="panel" class="flex flex-col gap-2">
          <div class="light">
            <p>light position:</p>

            <div class="ml-7">
              <div class="my-1">
                <label>X: </label>
                <input
                  id="light_x"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Y: </label>
                <input
                  id="light_y"
                  type="number"
                  value="0"
                  step="0.01"
                  class="border pl-1" />
              </div>
              <div class="my-1">
                <label>Z: </label>
                <input
                  id="light_z"
                  type="number"
                  value="1"
                  step="0.01"
                  class="border pl-1" />
              </div>
            </div>

            <div class="camera">
              <p>camera:</p>

              <div class="flex gap-4">
                <label class="ml-4">- preset</label>
                <div>
                  <button id="frontCamera" type="button" class="border px-1">
                    front
                  </button>
                  <button id="sideCamera" type="button" class="border px-1">
                    side
                  </button>
                  <button id="topCamera" type="button" class="border px-1">
                    top
                  </button>
                </div>
              </div>

              <label class="ml-4">- eye</label>
              <div class="ml-7">
                <div class="my-1">
                  <label>X: </label>
                  <input
                    id="eye_x"
                    type="number"
                    value="0"
                    step="0.01"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Y: </label>
                  <input
                    id="eye_y"
                    type="number"
                    value="0"
                    step="0.01"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Z: </label>
                  <input
                    id="eye_z"
                    type="number"
                    value="1"
                    step="0.01"
                    class="border pl-1" />
                </div>
              </div>

              <label class="ml-4">- at</label>
              <div class="ml-7">
                <div class="my-1">
                  <label>X: </label>
                  <input
                    id="at_x"
                    type="number"
                    value="0"
                    step="0.01"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Y: </label>
                  <input
                    id="at_y"
                    type="number"
                    value="0"
                    step="0.01"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Z: </label>
                  <input
                    id="at_z"
                    type="number"
                    value="0"
                    step="0.01"
                    class="border pl-1" />
                </div>
              </div>

              <label class="ml-4">- up</label>
              <div class="ml-7">
                <div class="my-1">
                  <label>X: </label>
                  <input
                    id="up_x"
                    type="number"
                    value="0"
                    step="1"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Y: </label>
                  <input
                    id="up_y"
                    type="number"
                    value="1"
                    step="1"
                    class="border pl-1" />
                </div>
                <div class="my-1">
                  <label>Z: </label>
                  <input
                    id="up_z"
                    type="number"
                    value="0"
                    step="1"
                    class="border pl-1" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script id="main">
        const rootManager = new RootManager();
        rootManager.init();

        rootManager.rootObject.children["robotArm"] = new RobotArm(
          new Transform({
            position: vec3(0, -0.8, 0),
            rotation: vec3(0, 0, -30),
          })
        );
        rootManager.canvasManager.render();

        setLight = (event) => {
          // console.clear();

          rootManager.canvasManager.lightPosition = vec4(
            parseFloat(light_x.value),
            parseFloat(light_y.value),
            parseFloat(light_z.value)
          );
          rootManager.canvasManager.lightingSync();
          rootManager.canvasManager.render();
        };

        setCanvas = (event) => {
          // console.clear();

          rootManager.cameraManager.eye = vec3(
            parseFloat(eye_x.value),
            parseFloat(eye_y.value),
            parseFloat(eye_z.value)
          );
          rootManager.cameraManager.at = vec3(
            parseFloat(at_x.value),
            parseFloat(at_y.value),
            parseFloat(at_z.value)
          );
          rootManager.cameraManager.up = vec3(
            parseFloat(up_x.value),
            parseFloat(up_y.value),
            parseFloat(up_z.value)
          );

          rootManager.canvasManager.render();
        };

        document
          .querySelectorAll("#light_x, #light_y, #light_z")
          .forEach((input) => {
            input.addEventListener("input", setLight);
          });
        document
          .querySelectorAll(
            "#eye_x, #eye_y, #eye_z, #at_x, #at_y, #at_z, #up_x, #up_y, #up_z"
          )
          .forEach((input) => {
            input.addEventListener("input", setCanvas);
          });

        resetCamera = () => {
          eye_x.value = 0;
          eye_y.value = 0;
          eye_z.value = 1;
          at_x.value = 0;
          at_y.value = 0;
          at_z.value = 0;
          up_x.value = 0;
          up_y.value = 1;
          up_z.value = 0;
        };

        frontCamera.addEventListener("click", (event) => {
          resetCamera();

          setCanvas();
        });
        sideCamera.addEventListener("click", (event) => {
          resetCamera();

          eye_x.value = 1;
          eye_y.value = 0;
          eye_z.value = 0;

          setCanvas();
        });
        topCamera.addEventListener("click", (event) => {
          resetCamera();

          eye_x.value = 0;
          eye_y.value = 1;
          eye_z.value = 0;

          up_x.value = 0;
          up_y.value = 0;
          up_z.value = -1;

          setCanvas();
        });
      </script>

      <script id="mouse">
        let prevMouseX = 0;
        let prevMouseY = 0;

        // 마우스가 움직일 때마다 호출
        function moveCameraByMouse(e) {
          const dx = e.clientX - prevMouseX;
          const dy = e.clientY - prevMouseY;

          // Debouncing, 마우스가 움직인 거리가 10 이하면 무시
          // 랜더링은 리소스를 많이 쓰므로
          if (dx * dx + dy * dy < 100) {
            return;
          }

          prevMouseX = e.clientX;
          prevMouseY = e.clientY;

          rootManager.cameraManager.moveCamera(vec3(-dx / 500, dy / 500, 0));

          // control panel과 동기화
          eye_x.value = rootManager.cameraManager.eye.X;
          eye_y.value = rootManager.cameraManager.eye.Y;
          eye_z.value = rootManager.cameraManager.eye.Z;

          at_x.value = rootManager.cameraManager.at.X;
          at_y.value = rootManager.cameraManager.at.Y;
          at_z.value = rootManager.cameraManager.at.Z;
          setCanvas();
        }

        // 마우스 버튼을 놓으면, moveCameraByMouse 제거
        function handleMouseUp(e) {
          if (e.button === 0) {
            // 왼쪽 마우스 버튼일 경우
            document.removeEventListener("mousemove", moveCameraByMouse);
            document.removeEventListener("mouseup", handleMouseUp);
          }
        }

        // 마우스 버튼이 눌리면 moveCameraByMouse 추가
        function handleMouseDown(e) {
          prevMouseX = e.clientX;
          prevMouseY = e.clientY;

          if (e.button === 0) {
            // 왼쪽 마우스 버튼일 경우
            document.addEventListener("mousemove", moveCameraByMouse);
            document.addEventListener("mouseup", handleMouseUp);
          }
        }

        // 초기에는 mousedown 리스너만
        document
          .getElementById("gl-canvas")
          .addEventListener("mousedown", handleMouseDown);
      </script>
    </div>
  </body>
</html>
